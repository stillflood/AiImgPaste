name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup AutoHotkey v2
      run: |
        # ä» GitHub Release ä¸‹è½½ AutoHotkey v2
        $ahkVersion = "2.0.18"
        Invoke-WebRequest -Uri "https://github.com/AutoHotkey/AutoHotkey/releases/download/v$ahkVersion/AutoHotkey_$ahkVersion.zip" -OutFile "ahk.zip"
        Expand-Archive "ahk.zip" -DestinationPath "AutoHotkey"
        
    - name: Setup Ahk2Exe Compiler
      run: |
        # ä¸‹è½½ Ahk2Exe ç¼–è¯‘å™¨ release ç‰ˆæœ¬
        Invoke-WebRequest -Uri "https://github.com/AutoHotkey/Ahk2Exe/releases/download/Ahk2Exe1.1.37.02a0a/Ahk2Exe1.1.37.02a0.zip" -OutFile "ahk2exe.zip"
        Expand-Archive "ahk2exe.zip" -DestinationPath "Compiler"
        
    - name: Compile script
      run: |
        # ç¼–è¯‘ 64 ä½ç‰ˆæœ¬
        .\Compiler\Ahk2Exe.exe /in AiPasteImg.ahk /out AiImgPaste_x64.exe /base ".\AutoHotkey\AutoHotkey64.exe"
        # ç¼–è¯‘ 32 ä½ç‰ˆæœ¬
        .\Compiler\Ahk2Exe.exe /in AiPasteImg.ahk /out AiImgPaste_x86.exe /base ".\AutoHotkey\AutoHotkey32.exe"
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        name: Release ${{ github.ref_name }}
        body: |
          ## ğŸ‰ è‡ªåŠ¨æ„å»ºçš„å‘å¸ƒç‰ˆæœ¬
          
          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          - **AiImgPaste_x64.exe** - 64 ä½ Windows ç‰ˆæœ¬ï¼ˆæ¨èï¼‰
          - **AiImgPaste_x86.exe** - 32 ä½ Windows ç‰ˆæœ¬ï¼ˆå…¼å®¹æ—§ç³»ç»Ÿï¼‰
          - æ— éœ€å®‰è£… AutoHotkeyï¼Œexe åŒ…å«æ‰€æœ‰ä¾èµ–
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ exe æ–‡ä»¶
          2. åŒå‡»è¿è¡Œï¼Œç¨‹åºä¼šåœ¨ç³»ç»Ÿæ‰˜ç›˜æ˜¾ç¤º
          3. æˆªå›¾åæŒ‰ `Alt+Shift+V` è‡ªåŠ¨ç²˜è´´è·¯å¾„
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          è¯¦è§ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
        draft: false
        prerelease: false
        files: |
          AiImgPaste_x64.exe
          AiImgPaste_x86.exe